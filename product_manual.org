#+TITLE: Space Cubics OBC製品マニュアル
#+SUBTITLE:
#+AUTHOR: Space Cubics
#+DATE: November 29, 2021
#+EMAIL: daisuke@spacecubics.com
#+OPTIONS: ^:{}
#+OPTIONS: H:6

* はじめに
Space Cubics OBCは、3U以上の CubeSatをターゲットとする On Board Computer(以下、OBC)です。

Space Cubics OBCはメインプロセッサ用デバイスとして Xilinx製 Artix-7 FPGAを採用し、FPGAにインプリする ARM Cortex-M3を核としたシステムです。
FPGAを採用する事で、インターフェースの種類や数を Cubesat毎に柔軟に対応する事ができます。
また、ユーザーの専用IPを実装する事により、特殊な処理を CPUのリソースを使わずに行う事ができ、システムのパフォーマンス向上を見込む事も可能です。

Space Cubics OBCには、メインプロセッサとは別にシステム管理をおこなうためのサブマイコンとして PIC16LF877を搭載します。
このサブマイコンは Timing, Reset, Config & Health Controller(以下、TRCH)と呼ばれ、FPGA起動前のシステムの管理や、FPGA起動後の異常検知を行います。
Space Cubics OBCは、TRCHにより異常発生時の自動復帰する機能を実現します。

* 製品概要
** 仕様

| Feature                                           | Description                                                                                 |
|---------------------------------------------------+---------------------------------------------------------------------------------------------|
| メインデバイス                                    | Xilinx Artix-7 (XC7A200T-1FBG676I)                                                          |
|                                                   | - Logic Cell 215,360                                                                        |
|                                                   | - CLB スライス数(4 LUT, 8 F/F) 33,650                                                       |
|                                                   | - CLB 最大分散RAM 2,888 Kb                                                                  |
|                                                   | - DSP48E1スライス 740                                                                       |
|                                                   | - BlockRAM 36 Kb x 365 (18 Kb x 730)                                                        |
|                                                   | - CMT 10                                                                                    |
|                                                   | - XADC 1                                                                                    |
|                                                   | - I/O Bank 10                                                                               |
| メインCPU                                         | ARM Cortex-M3 Design Start FPGA Xilinx Edition r0p1                                         |
|                                                   | - CPU Revision r2p1                                                                         |
|                                                   | - ARMv7-M architecture profile                                                              |
|                                                   | - Maximum operation frewuency up to 96 MHz (T.B.D.)                                         |
| TRCH                                              | PIC16LF877 8 bit RISC CPU                                                                   |
|                                                   | - operation frequency 4 MHz                                                                 |
| FPGA源発振クロック                                | 24 MHz                                                                                      |
| On Chip SRAM                                      | 64 kByte of FPGA BlockRAM                                                                   |
|                                                   | - ECC Memory Protection                                                                     |
|                                                   | - Memory Scrubbing                                                                          |
| On Borad SRAM                                     | 4 MByte Asynchronouse Static RAM (CY7C1061GE)                                               |
| NOR Flash for Configuration and Code Flash Memory | 32 MByte/Redundancy (S25FL256L)                                                             |
| NOR Flash for Data Memory                         | 32 MByte/Redundancy (S25FL256L)                                                             |
| FeRAM                                             | 512 kByte x 2 (CY15B104QSN)                                                                 |
| Control Area Network (CAN)                        | Conforms to the ISO 11898-1, CAN2.0A, and CAN2.0B standards Supports bit rates up to 1 Mb/s |
| Space Communication Bus (SCBus)                   | Compliant with the USB-based communication interface proposed by Space Cubics (T.B.D.)      |
|                                                   | - Supports bit rates 12 Mbps (USB Full-Speed)                                               |
| I2C Interface                                     | Accessible from FPGA and TRCH x 1                                                           |
| Serial Interface                                  | TRCH UART Interface x 1                                                                     |
| FPGA User IO                                      | User IO Group 1 x 16 pin (IO電圧可変)                                                       |
|                                                   | User IO Group 2 x 16 pin (IO電圧可変)                                                       |
|                                                   | User IO Group 4 x 6 pin, Cortex-M3 JTAG兼用 (3.3V固定)                                      |
| TRCH User IO                                      | User IO Group 3 x 3 pin (3.3V固定)                                                          |
| 電源電圧                                          | DC 3.5 〜　5.5 V (T.B.D.)                                                                   |
| 消費電力                                          | 2.0 W (Max)                                                                                 |
| 使用温度範囲                                      | -40 〜 80 ℃ (T.B.D.)                                                                       |
| 外形サイズ                                        | 70 mm x 70 mm (T.B.D.)                                                                      |

** Block Diagram
Space Cubics OBCは、FPGAを採用することによる高い柔軟性を維持するために、OBC Moduleと IO Boardの 2枚の基板で構成されます。

OBC Moduleは、Space Cubics OBCを採用するシステムのインターフェース構成が変わっても影響しない再利用性の高い機能が実装されています。
一方、IO Boardにはインターフェースの電気的特性を満たすために必要は Transceiver ICや プロトコルコンバータ ICなど、システム構成に影響を受ける機能を実装します。

Space Cubics OBCを使うユーザーは、衛星のシステムが変更になっても IO Boardを再設計する事で、新しい衛星に適合させる事ができます。
衛星のシステムが変わっても、同じ OBC Moduleを採用するシステムでは、多くのソフトウェア資産を流用する事ができます。

OBC Moduleと IO Boardは 80ピンの Board to Boardコネクタで接続します。

#+CAPTION: OBC Module Block Diagram
[[file:./images/BlockDiagram.png]]

* インターフェース仕様
Space Cubics OBC Moduleのインターフェース仕様について説明します。

** CON1 (IO Boardインターフェース)
IO Boardインターフェースは、OBC Moduleと IO Boardを接続するためのインターフェースです。
このインターフェースには Panasonic製の 0.5 mmピッチ 80ピンコネクタ(型番: AXK6S80547YG)が実装されています。
嵌合相手となる IO Boardには、嵌合の高さ 5mm, 5.5mm, 8mmのいずれかのソケットで接続してください。

コネクタの位置については、形状図を参照してください。

#+CAPTION: CON1信号配列 (1/3)
| ピン番号 | ピン名       | I/O    | 電源ドメイン | 説明                                                          |
|----------+--------------+--------+--------------+---------------------------------------------------------------|
|        1 | VIN_A        | Power  | -            | 電源(VIN_A)                                                   |
|        2 | VIN_A        | Power  | -            | 電源(VIN_A)                                                   |
|        3 | VIN_A        | Power  | -            | 電源(VIN_A)                                                   |
|        4 | ULPI_DP      | Inout  | -            | SC Bus D+信号                                                 |
|        5 | ULPI_DM      | Inout  | -            | SC Bus D-信号                                                 |
|        6 | GND          | Power  | -            | 電源(GND)                                                     |
|        7 | UIO1_00      | Inout  | VDD_UIO1     | User IO1 Bit 0信号、FPGAの IO_L13P_T2_MRCC_34 (pin: R3)に接続 |
|        8 | UIO1_01      | Inout  | VDD_UIO1     | User IO1 Bit 1信号、FPGAの IO_L13N_T2_MRCC_34 (pin: P3)に接続 |
|        9 | UIO1_02      | Inout  | VDD_UIO1     | User IO1 Bit 2信号、FPGAの IO_L14P_T2_SRCC_34 (pin: P4)に接続 |
|       10 | UIO1_03      | Inout  | VDD_UIO1     | User IO1 Bit 3信号、FPGAの IO_L14N_T2_SRCC_34 (pin: N4)に接続 |
|       11 | UIO1_04      | Inout  | VDD_UIO1     | User IO1 Bit 4信号、FPGAの IO_L11P_T1_SRCC_34 (pin: M2)に接続 |
|       12 | UIO1_05      | Inout  | VDD_UIO1     | User IO1 Bit 5信号、FPGAの IO_L11N_T1_SRCC_34 (pin: L2)に接続 |
|       13 | UIO1_06      | Inout  | VDD_UIO1     | User IO1 Bit 6信号、FPGAの IO_L10P_T1_34 (pin: H2)に接続      |
|       14 | UIO1_07      | Inout  | VDD_UIO1     | User IO1 Bit 7信号、FPGAの IO_L10N_T1_34 (pin: H1)に接続      |
|       15 | GND          | Power  | -            | 電源(GND)                                                     |
|       16 | UIO1_08      | Inout  | VDD_UIO1     | User IO1 Bit 8信号、FPGAの IO_L7P_T1_34 (pin: K1)に接続       |
|       17 | UIO1_09      | Inout  | VDD_UIO1     | User IO1 Bit 9信号、FPGAの IO_L7N_T1_34 (pin: J1)に接続       |
|       18 | UIO1_10      | Inout  | VDD_UIO1     | User IO1 Bit 10信号、FPGAの IO_L9P_T1_DQS_34 (pin: N1)に接続  |
|       19 | UIO1_11      | Inout  | VDD_UIO1     | User IO1 Bit 11信号、FPGAの IO_L9N_T1_DQS_34 (pin: M1)に接続  |
|       20 | UIO1_12      | Inout  | VDD_UIO1     | User IO1 Bit 12信号、FPGAの IO_L18P_T2_34 (pin: U2)に接続     |
|       21 | UIO1_13      | Inout  | VDD_UIO1     | User IO1 Bit 13信号、FPGAの IO_L18N_T2_34 (pin: U1)に接続     |
|       22 | UIO1_14      | Inout  | VDD_UIO1     | User IO1 Bit 14信号、FPGAの IO_L1P_T0_34 (pin: K3)に接続      |
|       23 | UIO1_15      | Inout  | VDD_UIO1     | User IO1 Bit 15信号、FPGAの IO_L1N_T0_34 (pin: J3)に接続      |
|       24 | GND          | Power  | -            | 電源(GND)                                                     |
|       25 | UIO3_00      | Inout  | VDD_3V3_IO   | User IO3 Bit 0信号、PIC16LF877の RD4/PSP4に接続               |
|       26 | UIO3_01      | Inout  | VDD_3V3_IO   | User IO3 Bit 1信号、PIC16LF877の RD5/PSP5に接続               |
|       27 | UIO3_02      | Inout  | VDD_3V3_IO   | User IO3 Bit 2信号、PIC16LF877の RD6/PSP6に接続               |
|       28 | UIO4_00      | Input  | VDD_3V3_IO   | User IO4 Bit 0信号、FPGAの IO_L22P_T3_12 (pin: AB16)に接続    |
|       29 | GND          | Power  | -            | 電源(GND)                                                     |
|       30 | TRCH_UART_TX | Output | VDD_3V3_IO   | TRCH UART TX信号、PIC16LF877の RC6/TX/CKに接続                |

#+CAPTION: CON1信号配列 (2/3)
| ピン番号 | ピン名       | I/O    | 電源ドメイン | 説明                                                                         |
|----------+--------------+--------+--------------+------------------------------------------------------------------------------|
|       31 | TRCH_UART_RX | Input  | VDD_3V3_IO   | TRCH UART RX信号、PIC16LF877の RC7/RX/DTに接続                               |
|       32 | TRCH_UART_EN | Output | VDD_3V3_IO   | TRCH UART Enable信号、PIC16LF877の RC2/CCP1に接続                            |
|       33 | GND          | Power  | -            | 電源(GND)                                                                    |
|       34 | I2C_EXT_SCL  | Output | VDD_3V3_IO   | TRCH UART TX信号、PIC16LF877の RC6/TX/CKに接続                               |
|       35 | I2C_EXT_SDA  | Inout  | VDD_3V3_IO   | TRCH UART RX信号、PIC16LF877の RC7/RX/DTに接続                               |
|       36 | WDOG_OUT     | Output | VDD_3V3_IO   | TRCH UART Enable信号、PIC16LF877の RC2/CCP1に接続                            |
|       37 | VDD_3V3_IO   | Power  | -            | 電源(VDD_3V3_IO)出力                                                         |
|       38 | VDD_3V3_IO   | Power  | -            | 電源(VDD_3V3_IO)出力                                                         |
|       39 | VDD_UIO1     | Power  | -            | 電源(VDD_UIO1)                                                               |
|       40 | VDD_UIO1     | Power  | -            | 電源(VDD_UIO1)                                                               |
|       41 | VDD_UIO2     | Power  | -            | 電源(VDD_UIO2)                                                               |
|       42 | VDD_UIO2     | Power  | -            | 電源(VDD_UIO2)                                                               |
|       43 | UIO4_05      | Inout  | VDD_3V3_IO   | User IO4 Bit 5/CM3 NTRST信号、FPGAの IO_0_13 (pin: U24)に接続                |
|       44 | UIO4_04      | Inout  | VDD_3V3_IO   | User IO4 Bit 4/CM3 TDO,SWO信号、FPGAの IO_L16P_T2_13 (pin: W20)に接続        |
|       45 | UIO4_03      | Inout  | VDD_3V3_IO   | User IO4 Bit 3/CM3 TDI信号、FPGAの IO_L16N_T2_13 (pin: Y20)に接続            |
|       46 | UIO4_02      | Inout  | VDD_3V3_IO   | User IO4 Bit 2/CM3 TMS,SWDIO信号、FPGAの IO_L14N_T2_SRCC_13 (pin: Y21)に接続 |
|       47 | UIO4_01      | Inout  | VDD_3V3_IO   | User IO4 Bit 1/CM3 TCK,SWCLK信号、FPGAの IO_L14P_T2_SRCC_13 (pin: W21)に接続 |
|       48 | GND          | Power  | -            | 電源(GND)                                                                    |
|       49 | ICPS_PGD     | Inout  | VDD_3V3_IO   | PIC PGD信号、PIC16LF877の RB7/PGDに接続                                      |
|       50 | ICPS_PGC     | Inout  | VDD_3V3_IO   | PIC PGC信号、PIC16LF877の RB6/PGCに接続                                      |
|       51 | ICSP_MCLR_B  | Inout  | VDD_3V3_IO   | PIC MCLR_B信号、PIC16LF877の MCLR/VPPに接続                                  |
|       52 | GND          | Power  | -            | 電源(GND)                                                                    |
|       53 | FPGA_TCK     | Output | VDD_3V3_IO   | FPGA JTAG TCK信号、FPGAの TCK_0 (pin: H12)に接続                             |
|       54 | FPGA_TDO     | Output | VDD_3V3_IO   | FPGA JTAG TDO信号、FPGAの TDO_0 (pin: J10)に接続                             |
|       55 | FPGA_TDI     | Input  | VDD_3V3_IO   | FPGA JTAG TDI信号、FPGAの TDI_0 (pin: H10)に接続                             |
|       56 | FPGA_TMS     | Output | VDD_3V3_IO   | FPGA JTAG TMS信号、FPGAの TMS_0 (pin: H11)に接続                             |
|       57 | GND          | Power  | -            | 電源(GND)                                                                    |
|       58 | UIO2_15      | Inout  | VDD_UIO2     | User IO2 Bit 15信号、FPGAの IO_L16N_T2_35 (pin: A4)に接続                    |
|       59 | UIO2_14      | Inout  | VDD_UIO2     | User IO2 Bit 14信号、FPGAの IO_L16P_T2_35 (pin: B4)に接続                    |
|       60 | UIO2_13      | Inout  | VDD_UIO2     | User IO2 Bit 13信号、FPGAの IO_L20N_T3_35 (pin: A2)に接続                    |
|       61 | UIO2_12      | Inout  | VDD_UIO2     | User IO2 Bit 12信号、FPGAの IO_L20P_T3_35 (pin: A3)に接続                    |
|       62 | UIO2_11      | Inout  | VDD_UIO2     | User IO2 Bit 11信号、FPGAの IO_L24N_T3_35 (pin: G1)に接続                    |
|       63 | UIO2_10      | Inout  | VDD_UIO2     | User IO2 Bit 10信号、FPGAの IO_L24P_T3_35 (pin: G2)に接続                    |
|       64 | UIO2_09      | Inout  | VDD_UIO2     | User IO2 Bit 9信号、FPGAの IO_L23N_T3_35 (pin: D1)に接続                     |
|       65 | UIO2_08      | Inout  | VDD_UIO2     | User IO2 Bit 8信号、FPGAの IO_L23P_T3_35 (pin: E1)に接続                     |
|       66 | GND          | Power  | -            | 電源(GND)                                                                    |
|       67 | UIO2_07      | Inout  | VDD_UIO2     | User IO2 Bit 7信号、FPGAの IO_L21N_T3_DQS_35 (pin: B1)に接続                 |
|       68 | UIO2_06      | Inout  | VDD_UIO2     | User IO2 Bit 6信号、FPGAの IO_L21P_T3_DQS_35 (pin: C1)に接続                 |
|       69 | UIO2_05      | Inout  | VDD_UIO2     | User IO2 Bit 5信号、FPGAの IO_L14N_T2_SRCC_35 (pin: C4)に接続                |
|       70 | UIO2_04      | Inout  | VDD_UIO2     | User IO2 Bit 4信号、FPGAの IO_L14P_T2_SRCC_35 (pin: D4)に接続                |

#+CAPTION: CON1信号配列 (3/3)
| ピン番号 | ピン名  | I/O   | 電源ドメイン | 説明                                                          |
|----------+---------+-------+--------------+---------------------------------------------------------------|
|       71 | UIO2_03 | Inout | VDD_UIO2     | User IO2 Bit 3信号、FPGAの IO_L11N_T1_SRCC_35 (pin: F4)に接続 |
|       72 | UIO2_02 | Inout | VDD_UIO2     | User IO2 Bit 2信号、FPGAの IO_L11P_T1_SRCC_35 (pin: G4)に接続 |
|       73 | UIO2_01 | Inout | VDD_UIO2     | User IO2 Bit 1信号、FPGAの IO_L13N_T2_MRCC_35 (pin: D5)に接続 |
|       74 | UIO2_00 | Inout | VDD_UIO2     | User IO2 Bit 0信号、FPGAの IO_L13P_T2_MRCC_35 (pin: E5)に接続 |
|       75 | GND     | Power | -            | 電源(GND)                                                     |
|       76 | CANL    | Inout | -            | SC OBC CAN L信号                                              |
|       77 | CANH    | Inout | -            | SC OBC CAN H信号                                              |
|       78 | VIN_B   | Power | -            | 電源(VIN_B)                                                   |
|       79 | VIN_B   | Power | -            | 電源(VIN_B)                                                   |
|       80 | VIN_B   | Power | -            | 電源(VIN_B)                                                   |

*** 電源入力
OBCへの電源は VIN_A, VIN_Bから入力します。

電源電圧の入力範囲は 3.5 〜 5.5Vです。

VIN_Aと VIN_Bは、冗長化の目的で OBC内部で別々の電源回路にて、OBC内部の電源を生成しています。
OBCに入力する電源が 1系統しか無い場合、VIN_Aと VIN_Bにはすべて同じ電源を接続して構いません。

*** User IO Group 1, 2
User IO Group 1, 2は、FPGAに接続され、ユーザーが自由に使用できる信号です。
User IO Group 1は FPGAの Bank 34、User IO Group 2は FPGAの Bank 35を専有しています。

| User IO | 信号名規則    | IO本数 | FPGA Bank | 対応するIO電源ピン |
|---------+---------------+--------+-----------+--------------------|
| Group 1 | UIO1_(Number) | 16本   | Bank 34   | VDD_UIO1           |
| Group 2 | UIO2_(Number) | 16本   | Bank 35   | VDD_UIO2           |

User IO Groupは VDD_UIO1, VDD_UIO02に任意の IO電圧を印加し使用する事ができます。
FPGAで使用したいIOに合ったIO電圧を印加してください。

FPGAの IO電源 (VCCO)は、FPGAの電源投入シーケンスに従い投入する必要があります。
OBC Moduleが出力する VDD_3V3信号が Highになった時のみ電圧を印加する事で、FPGAの電源シーケンスを守る事ができます。

以下の回路構成例を参考に、回路を構成してください。
回路例は User IO Group 1の場合の例のため、User Io Group 2に適用する場合、ピン番号などを読み替えてください。

#+CAPTION: User IO Group 1を 3.3 Vで使用する場合の回路構成例
#+ATTR_HTML: :width 350
[[file:./images/user_io_vdd33.png]]

User IOを 3.3 Vで使用する場合で、且つ IO Boardの回路の消費電流が 0.3 A未満の場合は、VDD_3V3を電源として使う事ができます。

#+CAPTION: User IO Group 1を 1.6Vで使用する場合の回路構成例
#+ATTR_HTML: :width 350
[[file:./images/user_io_vdd16.png]]

User IOを 1.6 Vで使用する場合や、IO Boardの回路の消費電流が 0.3 A以上の場合は、VDD_3V3をイネーブル信号とし、IO Board上で生成した電源を供給してください。

* FPGAシステム仕様
Space Cubics OBCのFPGAは、 Space Cubics OBCの主要機能を司るプロセッサです。
この章では Configuration後の FPGA機能について説明します。

#+CAPTION: Space Cubics OBC FPGA Block Diagram
[[file:./images/FPGA_BlockDiagram.png]]

Space Cubics OBCは ARM Cortex-M3を CPUに採用したシステムを構築します。

** FPGAシステム構成概要
システムは大きく 6つの機能に分割されます。

- System Controller
System Controllerは、FPGAのクロック, リセットを生成するためのモジュールです。
このモジュールで生成されるクロック, リセットは、FPGA全体に供給されます。

- CPU (ARM Cortex-M3)
Space Cubics OBCの FPGA機能を司る CPUを構成するモジュールです。
CPUはソフトコアで実装し、ARM Cortex-M3 Design Start FPGA-Xilinx editionを採用します。

- Main Memory System
Main Memory Systemは CPUが私用するメモリシステムである。
CPUとの接続は AXIで行われ、本システムは CPU Local Busとして実装します。

CPU Local Busは CPUモジュール内部の ARM Cortex-M3の Instruction code AHB, Data code AHBをまとめたバスとして構成されています。
このバスは AXI Interconnectorなどで分岐せず、メモリを直接付加し構成する事で Instructionアクセスのレイテンシーを最小限に抑えるよう設計されています。

- Main AXI Bus System
Main AXI Bus Systemは、CubeSat向けの OBCシステムとして必須となる機能の中で、アクセススピードが比較的重視されるIPをまとまたシステムです。

このバスには、コンピュータシステムとして必要なメモリコントロールIPや CubeSatのメインの通信バスとなる CANのコントローラIPなどが接続されています。

- Low Performance AHB System
Low Performance AHB Systemは、CubeSat向け OBCシステムとして必須となる機能の中、アクセス頻度の低いIPをまとめたシステムです。

このシステムはバスに AHBを採用する事で、IPの回路規模を小さくする事ができます。
このバスには、システムレジスタやI2Cコントローラなどが接続されます。

- Mission Bus System
Mission Bus SystemはCubeSatのミッションを行うためのIPを接続するシステムです。

ユーザーのロジックをはじめとするミッションに関わるIPはこのバスに接続されます。

* 形状図
** Space Cubics OBC基板形状図
#+CAPTION: OBC基板形状 および 固定穴寸法
[[file:./images/sc-obc-layout.png]]
